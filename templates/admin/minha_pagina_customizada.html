{% extends "admin/base_site.html" %}

{% block title %}Angenda{% endblock %}

{% block extrahead %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<style>
  /* Wrapper do calendário */
  .agenda-wrapper {
    display: flex;
    width: 100%;
    align-items: flex-start;
    gap: 20px;
    padding: 20px;
  }

  #calendar {
    background-color: white;
    padding: 0 10px 10px 10px;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    border-top: 5px solid #FFD700;
    flex: 1;
  }

  /* Estilo geral do modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    padding-top: 80px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.3);
  }

  .modal-content.large {
    background-color: #fff;
    margin: auto;
    padding: 25px 30px;
    width: 600px;
    max-width: 95%;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    position: relative;
  }

  .close {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #aaa;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: #000;
  }

  .modal-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  .tab-button {
    padding: 8px 16px;
    border: none;
    background: #f0f0f0;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
  }

  .tab-button.active {
    background: #3788d8;
    color: white;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .form-field {
    margin-bottom: 16px;
  }

  label {
    display: block;
    font-weight: 500;
    margin-bottom: 6px;
    color: #444;
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus,
  select:focus,
  textarea:focus {
    border-color: #3788d8;
  }

  textarea {
    resize: vertical;
  }

  .form-row {
    display: flex;
    gap: 15px;
  }

  .form-field.half {
    flex: 1;
  }

  .form-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 20px;
  }

  #btnSalvar {
    flex: 1;
    padding: 10px;
    background-color: #3788d8;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #btnSalvar:hover {
    background-color: #2c6fc1;
  }

  #btnExcluir {
    flex: 1;
    padding: 10px;
    background-color: #e74c3c;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #btnExcluir:hover {
    background-color: #c0392b;
  }

  button[type="button"] {
    margin-top: 5px;
    background-color: transparent;
    color: #3788d8;
    border: none;
    font-size: 13px;
    cursor: pointer;
  }

  button[type="button"]:hover {
    text-decoration: underline;
  }

  #modalNovoTipo .modal-content {
    width: 350px;
    max-width: 90%;
    padding: 25px 30px;
    border-radius: 10px;
    background-color: #fff;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    position: relative;
    margin: auto;
    animation: fadeInScale 0.2s ease-in-out;
  }

  #modalNovoTipo h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
    color: #333;
    text-align: center;
  }

  #modalNovoTipo .form-field label {
    font-weight: 500;
    margin-bottom: 6px;
    color: #444;
  }

  #modalNovoTipo input[type="text"],
  #modalNovoTipo input[type="color"] {
    padding: 10px;
    width: 100%;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  #modalNovoTipo input:focus {
    border-color: #3788d8;
  }

  #modalNovoTipo input[type="color"] {
    height: 40px;
    padding: 4px;
  }

  #modalNovoTipo button[type="submit"] {
    margin-top: 15px;
    width: 100%;
    padding: 10px 14px;
    background-color: #3788d8;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #modalNovoTipo button[type="submit"]:hover {
    background-color: #2c6fc1;
  }

  #modalNovoTipo .close {
    position: absolute;
    top: 12px;
    right: 18px;
    color: #aaa;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
  }

  #modalNovoTipo .close:hover {
    color: #000;
  }

.color-picker {
    background-color: transparent;
}


</style>

{% endblock %}

{% block sidebar %}
{{ block.super }}
{% endblock %}

{% block content %}
<div class="agenda-wrapper">
  <div id="calendar"></div>
</div>

<!-- Modal -->
<div id="eventModal" class="modal">
  <div class="modal-content large">
    <span class="close" onclick="fecharModal()">&times;</span>

    <div class="modal-tabs">
      <button class="tab-button active" onclick="abrirAba('abaInfo')">Compromisso</button>
      <button class="tab-button" onclick="abrirAba('abaExtras')">Extras</button>
    </div>

    <form id="eventForm">
      <!-- Aba Compromisso -->
      <div id="abaInfo" class="tab-content active">
        <div class="form-field">
          <label for="titulo">Título:</label>
          <input type="text" id="titulo" name="titulo" required>
        </div>

        <div class="form-row">
          <div class="form-field half">
            <label for="dataInicio">Início:</label>
            <input type="datetime-local" id="dataInicio" name="dataInicio" required>
          </div>
          <div class="form-field half">
            <label for="dataFim">Fim:</label>
            <input type="datetime-local" id="dataFim" name="dataFim">
          </div>
        </div>

        <div class="form-field">
          <label for="tipo">Tipo:</label>
          <select id="tipo" name="tipo"></select>
          <button type="button" onclick="abrirModalTipo()">+ Novo tipo</button>
        </div>
      </div>

      <!-- Aba Extras -->
      <div id="abaExtras" class="tab-content">
        <div class="form-field">
          <label for="local">Local:</label>
          <input type="text" id="local" name="local">
        </div>

        <div class="form-field">
          <label for="obs">Observações:</label>
          <textarea id="obs" name="obs"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" id="btnSalvar">Salvar</button>
        <button type="button" id="btnExcluir" style="display:none;">Excluir</button>
      </div>
    </form>
  </div>
</div>


<!-- Modal para adicionar novo tipo -->
<div id="modalNovoTipo" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModalTipo()">&times;</span>
    <h3>Novo Tipo de Compromisso</h3>
    <form id="formNovoTipo">
      <div class="form-field">
        <label for="novoTipoNome">Nome do tipo:</label>
        <input type="text" id="novoTipoNome" required />
      </div>
      <div class="form-field">
        <label for="novoTipoCor">Cor:</label>
        <input type="color" id="novoTipoCor" class="color-picker" value="#3788d8" required />
      </div>
      <button type="submit">Salvar</button>
    </form>

  </div>
</div>
<!-- Calendário -->


<script>
  let selectedDate = null;
  function carregarTipos(callback = null) {
    fetch('/api/tipos/')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('tipo');
        select.innerHTML = '';
        data.forEach(tipo => {
          const option = document.createElement('option');
          option.value = tipo.id;
          option.textContent = tipo.nome;
          select.appendChild(option);
        });
        if (callback) callback();  // ⬅️ Chama após carregar
      });
  }

  function abrirModalTipo() {
    document.getElementById('modalNovoTipo').style.display = 'block';
    document.getElementById('novoTipoNome').value = '';
  }
  function abrirAba(id) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.tab-button[onclick*="${id}"]`).classList.add('active');
    document.getElementById(id).classList.add('active');
  }

  function fecharModalTipo() {
    document.getElementById('modalNovoTipo').style.display = 'none';
  }

  document.getElementById('formNovoTipo').addEventListener('submit', function (e) {
    e.preventDefault();
    const nome = document.getElementById('novoTipoNome').value;
    const cor = document.getElementById('novoTipoCor').value;

    fetch('/api/tipos/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({ nome, cor })
    })
      .then(response => {
        if (!response.ok) throw new Error();
        return response.json();
      })
      .then(novoTipo => {
        fecharModalTipo();
        carregarTipos();
        setTimeout(() => {
          document.getElementById('tipo').value = novoTipo.id;
        }, 200);
      })
      .catch(() => alert('Erro ao salvar tipo.'));
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  function abrirModal(data) {
    selectedDate = data;
    document.getElementById("dataInicio").value = data + "T09:00";
    document.getElementById("dataFim").value = data + "T10:00";
    document.getElementById("eventModal").style.display = "block";
  }

  function fecharModal() {
    document.getElementById("eventModal").style.display = "none";
    document.getElementById("eventForm").reset();
    document.getElementById("eventForm").dataset.eventoId = "";
    document.getElementById("btnExcluir").style.display = "none";
  }

  document.addEventListener('DOMContentLoaded', function () {
    //new FullCalendar.Draggable(document.getElementById('external-events'), {
    //  itemSelector: '.fc-event',
    //  eventData: function (eventEl) {
    //    return JSON.parse(eventEl.dataset.event);
    //  }
    //});

    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      droppable: true,
      editable: true,
      selectable: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      events: '/api/compromissos/',
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      },
      dateClick: function (info) {
        abrirModal(info.dateStr);
      },
      eventDrop: function (info) {
        const evento = info.event;

        const dadosAtualizados = {
          start: evento.start.toISOString(),
          end: evento.end ? evento.end.toISOString() : null,
        };

        fetch(`/api/compromissos/${evento.id}/`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify(dadosAtualizados)
        })
          .then(response => {
            if (!response.ok) throw new Error();
          })
          .catch(() => {
            info.revert(); // volta para posição anterior
            alert('Erro ao mover compromisso.');
          });
      },
      eventClick: function (info) {
        const evento = info.event;
        console.log(evento.extendedProps);
        // Preenche os campos do formulário
        document.getElementById("titulo").value = evento.title;
        document.getElementById("dataInicio").value = evento.start.toISOString().slice(0, 16);
        document.getElementById("dataFim").value = evento.end ? evento.end.toISOString().slice(0, 16) : "";
        document.getElementById("local").value = evento.extendedProps.local || "";
        document.getElementById("obs").value = evento.extendedProps.observacoes || "";
        document.getElementById("tipo").value = evento.extendedProps.tipo.id || "123";

        // Armazena o ID do evento em edição (usado no submit ou delete)
        document.getElementById("eventForm").dataset.eventoId = evento.id;
        document.getElementById("btnExcluir").style.display = "inline-block";

        document.getElementById("eventModal").style.display = "block";

      },
      eventResize: function (info) {
        const evento = info.event;

        const dadosAtualizados = {
          start: evento.start.toISOString(),
          end: evento.end ? evento.end.toISOString() : null,
        };

        fetch(`/api/compromissos/${evento.id}/`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify(dadosAtualizados)
        })
          .then(response => {
            if (!response.ok) throw new Error();
          })
          .catch(() => {
            info.revert(); // volta ao tamanho original
            alert('Erro ao redimensionar compromisso.');
          });
      },
      dayMaxEventRows: 1, // OU dayMaxEvents: 3
      views: {
        dayGridMonth: {
          dayMaxEventRows: 1 // só aplica ao modo mês
        }
      },

    });
    carregarTipos();
    calendar.render();
    document.getElementById("eventForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const id = this.dataset.eventoId || null;
      const method = id ? "PATCH" : "POST";
      const url = id ? `/api/compromissos/${id}/` : "/api/compromissos/";

      const dados = {
        title: document.getElementById("titulo").value,
        start: document.getElementById("dataInicio").value,
        end: document.getElementById("dataFim").value || null,
        tipo_id: document.getElementById("tipo").value,
        status: "agendado",
        local: document.getElementById("local").value,
        cliente: null,
        observacoes: document.getElementById("obs").value
      };

      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(dados)
      })
        .then(response => {
          if (!response.ok) throw new Error();
          return response.json();
        })
        .then(() => {
          fecharModal();
          calendar.refetchEvents();
        })
        .catch(() => {
          alert('Erro ao salvar compromisso.');
        });
    });
    document.getElementById("btnExcluir").addEventListener("click", function () {
      const id = document.getElementById("eventForm").dataset.eventoId;
      if (!id) return;

      if (!confirm("Deseja realmente excluir este compromisso?")) return;

      fetch(`/api/compromissos/${id}/`, {
        method: "DELETE",
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      })
        .then(response => {
          if (!response.ok) throw new Error();
          fecharModal();
          calendar.refetchEvents();
        })
        .catch(() => {
          alert("Erro ao excluir compromisso.");
        });
    });

  });


</script>

</div>

{% endblock %}